from typing import Dict, Optional


def build_debug_prompt(
    context: Dict[str, str],
    code: str,
    error_log: Optional[str] = None
) -> str:
    """
    ูุจูู Prompt ูุฎุตุต ููููู ุชุตุญูุญ ุฃุฎุทุงุก (Debug Agent)
    ุจุฏูู ุชุนุฏูู ุฃู ููุฏ (READ-ONLY)
    """

    def ctx(name: str) -> str:
        return context.get(name, f"[MISSING CONTEXT: {name}]")

    parts = []

    # ===============================
    # ๐ง ุชุนุฑูู ุงูุฏูุฑ
    # ===============================
    parts.append(
        "ุฃูุช ูุณุงุนุฏ ุจุฑูุฌู ูุชุฎุตุต ูู ุชุตุญูุญ ุฃุฎุทุงุก ูุดุงุฑูุน Python / FastAPI.\n"
        "ุฃูุช ุชุนูู ุจูุถุน READ-ONLY ููุง ุชุนุฏูู ุงูููุฏ ุชููุงุฆููุง."
    )

    # ===============================
    # ๐ ููุงุนุฏ ุงูุณููู
    # ===============================
    parts.append(
        "\n=== ููุงุนุฏ ุงูุงูุชุฒุงู ===\n"
        + ctx("AI_DEBUG_RULES.md")
    )

    # ===============================
    # ๐บ๏ธ ุฎุฑูุทุฉ ุงููุธุงู
    # ===============================
    parts.append(
        "\n=== ุฎุฑูุทุฉ ุงููุธุงู ===\n"
        + ctx("SYSTEM_MAP.md")
    )

    # ===============================
    # ๐ ุงูููุงุนุฏ ุงููุญุงุณุจูุฉ
    # ===============================
    parts.append(
        "\n=== ุงูููุงุนุฏ ุงููุญุงุณุจูุฉ ===\n"
        + ctx("ACCOUNTING_RULES.md")
    )

    # ===============================
    # ๐งฏ ุณุฌู ุงูุฎุทุฃ (ุฅู ูุฌุฏ)
    # ===============================
    if error_log:
        parts.append(
            "\n=== ุณุฌู ุงูุฎุทุฃ ===\n"
            + error_log
        )

    # ===============================
    # ๐งฉ ุงูููุฏ ุงููุฏู
    # ===============================
    parts.append(
        "\n=== ุงูููุฏ ุงููุฏู ===\n"
        + code
    )

    # ===============================
    # โ ุงููุทููุจ ูู ุงููุณุงุนุฏ
    # ===============================
    parts.append(
        "\n=== ุงููุทููุจ ===\n"
        "1) ุงุดุฑุญ ุณุจุจ ุงููุดููุฉ ุจูุบุฉ ุนุฑุจูุฉ ูุงุถุญุฉ.\n"
        "2) ุงูุชุฑุญ ุฅุตูุงุญูุง ูุงุญุฏูุง ููุท (Minimal Fix).\n"
        "3) ุงุฐูุฑ ููุงุฐุง ูุฐุง ุงูุฅุตูุงุญ ุขูู ููุง ููุณุฑ ุงููุธุงู.\n"
        "4) ูุง ุชูุชุฑุญ ุฅุนุงุฏุฉ ููููุฉ ูุจูุฑุฉ ุฃู ุชุบููุฑุงุช ูุงุณุนุฉ.\n"
        "5) ูุง ุชูุชุจ ููุฏ ูุงูู ุฅูุง ุฅุฐุง ุทููุจ ุตุฑุงุญุฉ.\n"
    )

    return "\n".join(parts)
